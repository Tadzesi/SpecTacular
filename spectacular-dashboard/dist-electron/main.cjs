"use strict";const r=require("electron"),g=require("path"),m=require("fs"),b=require("chokidar");function f(n){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(n){for(const t in n)if(t!=="default"){const o=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,o.get?o:{enumerable:!0,get:()=>n[t]})}}return e.default=n,Object.freeze(e)}const c=f(g),p=f(m);class y{constructor(e,t){this.watcher=null,this.watching=!1,this.paused=!1,this.rootPath=e,this.callback=t}start(){this.watcher&&this.stop(),this.watcher=b.watch(this.rootPath,{persistent:!0,ignoreInitial:!0,depth:99,ignored:/(^|[\/\\])\../,awaitWriteFinish:{stabilityThreshold:300,pollInterval:100}}),this.watcher.on("add",e=>this.handleEvent("add",e)).on("change",e=>this.handleEvent("change",e)).on("unlink",e=>this.handleEvent("unlink",e)).on("addDir",e=>this.handleEvent("addDir",e)).on("unlinkDir",e=>this.handleEvent("unlinkDir",e)).on("error",e=>console.error("Watcher error:",e)),this.watching=!0,this.paused=!1}handleEvent(e,t){this.paused||e!=="addDir"&&e!=="unlinkDir"&&!t.endsWith(".md")||this.callback({type:e,path:t,timestamp:Date.now()})}stop(){this.watcher&&(this.watcher.close(),this.watcher=null),this.watching=!1,this.paused=!1}pause(){this.paused=!0}resume(){this.paused=!1}isWatching(){return this.watching&&!this.paused}isPaused(){return this.paused}}r.app.disableHardwareAcceleration();r.app.commandLine.appendSwitch("disable-gpu");r.app.commandLine.appendSwitch("disable-gpu-compositing");r.app.commandLine.appendSwitch("disable-gpu-shader-disk-cache");let a=null,s=null;function v(){const n=process.argv.slice(1);for(let e=0;e<n.length;e++)if(n[e]==="--path"&&n[e+1])return n[e+1];return c.join(process.cwd(),"specs")}let u=v();function D(){const n=[{label:"File",submenu:[{label:"Select Folder...",accelerator:"CmdOrCtrl+O",click:async()=>{const t=await r.dialog.showOpenDialog(a,{properties:["openDirectory"],title:"Select Specs Directory"});!t.canceled&&t.filePaths[0]&&(u=t.filePaths[0],a==null||a.webContents.send("folder-selected",t.filePaths[0]))}},{type:"separator"},{label:"Exit",accelerator:"Alt+F4",click:()=>r.app.quit()}]},{label:"Edit",submenu:[{role:"undo"},{role:"redo"},{type:"separator"},{role:"cut"},{role:"copy"},{role:"paste"},{role:"selectAll"}]},{label:"View",submenu:[{role:"reload"},{role:"forceReload"},{role:"toggleDevTools"},{type:"separator"},{role:"resetZoom"},{role:"zoomIn"},{role:"zoomOut"},{type:"separator"},{role:"togglefullscreen"}]},{label:"Window",submenu:[{role:"minimize"},{role:"close"}]},{label:"Help",submenu:[{label:"About SpecTacular",click:()=>{r.dialog.showMessageBox(a,{type:"info",title:"About SpecTacular",message:"SpecTacular Dashboard",detail:`Version 1.0.0
A specification viewer and task tracker.`})}}]}],e=r.Menu.buildFromTemplate(n);r.Menu.setApplicationMenu(e)}function h(){a=new r.BrowserWindow({width:1400,height:900,minWidth:800,minHeight:600,webPreferences:{preload:c.join(__dirname,"preload.cjs"),nodeIntegration:!1,contextIsolation:!0},titleBarStyle:"default",show:!0}),process.env.VITE_DEV_SERVER_URL?(a.loadURL(process.env.VITE_DEV_SERVER_URL),a.webContents.openDevTools()):a.loadFile(c.join(__dirname,"../dist/index.html")),a.on("closed",()=>{a=null,s==null||s.stop()}),a.webContents.on("before-input-event",(n,e)=>{e.type==="mouseDown"&&(e.button==="back"?a==null||a.webContents.send("navigate-back"):e.button==="forward"&&(a==null||a.webContents.send("navigate-forward")))})}function w(n,e){const t=[];try{const o=p.readdirSync(n,{withFileTypes:!0});for(const i of o){if(i.name.startsWith("."))continue;const l=c.join(n,i.name),S=c.relative(e,l);if(i.isDirectory()){const d=w(l,e);t.push({name:i.name,path:l,type:"folder",children:d})}else if(i.name.endsWith(".md")){const d=p.statSync(l);t.push({name:i.name,path:l,type:"file",lastModified:d.mtimeMs})}}}catch(o){console.error(`Error reading directory ${n}:`,o)}return t.sort((o,i)=>o.type!==i.type?o.type==="folder"?-1:1:o.name.localeCompare(i.name)),t}r.ipcMain.handle("get-file-tree",async(n,e)=>{const t=e||u;return p.existsSync(t)?w(t,t):[]});r.ipcMain.handle("read-file",async(n,e)=>{try{if(!p.existsSync(e))throw new Error(`File not found: ${e}`);return p.readFileSync(e,"utf-8")}catch(t){throw console.error(`Error reading file ${e}:`,t),t}});r.ipcMain.handle("select-directory",async()=>{const n=await r.dialog.showOpenDialog(a,{properties:["openDirectory"],title:"Select Specs Directory"});return n.canceled?null:n.filePaths[0]});r.ipcMain.handle("get-config",async()=>({rootPath:u,watchEnabled:(s==null?void 0:s.isWatching())??!1}));r.ipcMain.on("start-watching",(n,e)=>{s&&s.stop(),s=new y(e,t=>{a==null||a.webContents.send("file-change",t)}),s.start()});r.ipcMain.on("stop-watching",()=>{s==null||s.stop()});r.ipcMain.on("set-watching",(n,e)=>{e?s==null||s.start():s==null||s.pause()});r.app.whenReady().then(()=>{D(),h(),r.app.on("activate",()=>{r.BrowserWindow.getAllWindows().length===0&&h()})});r.app.on("window-all-closed",()=>{s==null||s.stop(),process.platform!=="darwin"&&r.app.quit()});
