"use strict";const a=require("electron"),g=require("path"),y=require("fs"),m=require("chokidar");function u(r){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const t in r)if(t!=="default"){const i=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:()=>r[t]})}}return e.default=r,Object.freeze(e)}const l=u(g),h=u(y);class b{constructor(e,t){this.watcher=null,this.watching=!1,this.paused=!1,this.rootPath=e,this.callback=t}start(){this.watcher&&this.stop(),this.watcher=m.watch(this.rootPath,{persistent:!0,ignoreInitial:!0,depth:99,ignored:/(^|[\/\\])\../,awaitWriteFinish:{stabilityThreshold:300,pollInterval:100}}),this.watcher.on("add",e=>this.handleEvent("add",e)).on("change",e=>this.handleEvent("change",e)).on("unlink",e=>this.handleEvent("unlink",e)).on("addDir",e=>this.handleEvent("addDir",e)).on("unlinkDir",e=>this.handleEvent("unlinkDir",e)).on("error",e=>console.error("Watcher error:",e)),this.watching=!0,this.paused=!1}handleEvent(e,t){this.paused||e!=="addDir"&&e!=="unlinkDir"&&!t.endsWith(".md")||this.callback({type:e,path:t,timestamp:Date.now()})}stop(){this.watcher&&(this.watcher.close(),this.watcher=null),this.watching=!1,this.paused=!1}pause(){this.paused=!0}resume(){this.paused=!1}isWatching(){return this.watching&&!this.paused}isPaused(){return this.paused}}a.app.disableHardwareAcceleration();a.app.commandLine.appendSwitch("disable-gpu-shader-disk-cache");let s=null,n=null;const f=l.join(process.cwd(),"..","..","specs");function p(){s=new a.BrowserWindow({width:1400,height:900,minWidth:800,minHeight:600,webPreferences:{preload:l.join(__dirname,"preload.cjs"),nodeIntegration:!1,contextIsolation:!0},titleBarStyle:"default",show:!1}),s.once("ready-to-show",()=>{s==null||s.show()}),process.env.VITE_DEV_SERVER_URL?(s.loadURL(process.env.VITE_DEV_SERVER_URL),s.webContents.openDevTools()):s.loadFile(l.join(__dirname,"../dist/index.html")),s.on("closed",()=>{s=null,n==null||n.stop()}),s.webContents.on("before-input-event",(r,e)=>{e.type==="mouseDown"&&(e.button==="back"?s==null||s.webContents.send("navigate-back"):e.button==="forward"&&(s==null||s.webContents.send("navigate-forward")))})}function w(r,e){const t=[];try{const i=h.readdirSync(r,{withFileTypes:!0});for(const o of i){if(o.name.startsWith("."))continue;const c=l.join(r,o.name),v=l.relative(e,c);if(o.isDirectory()){const d=w(c,e);t.push({name:o.name,path:c,type:"folder",children:d})}else if(o.name.endsWith(".md")){const d=h.statSync(c);t.push({name:o.name,path:c,type:"file",lastModified:d.mtimeMs})}}}catch(i){console.error(`Error reading directory ${r}:`,i)}return t.sort((i,o)=>i.type!==o.type?i.type==="folder"?-1:1:i.name.localeCompare(o.name)),t}a.ipcMain.handle("get-file-tree",async(r,e)=>{const t=e||f;return h.existsSync(t)?w(t,t):[]});a.ipcMain.handle("read-file",async(r,e)=>{try{if(!h.existsSync(e))throw new Error(`File not found: ${e}`);return h.readFileSync(e,"utf-8")}catch(t){throw console.error(`Error reading file ${e}:`,t),t}});a.ipcMain.handle("select-directory",async()=>{const r=await a.dialog.showOpenDialog(s,{properties:["openDirectory"],title:"Select Specs Directory"});return r.canceled?null:r.filePaths[0]});a.ipcMain.handle("get-config",async()=>({rootPath:f,watchEnabled:(n==null?void 0:n.isWatching())??!1}));a.ipcMain.on("start-watching",(r,e)=>{n&&n.stop(),n=new b(e,t=>{s==null||s.webContents.send("file-change",t)}),n.start()});a.ipcMain.on("stop-watching",()=>{n==null||n.stop()});a.ipcMain.on("set-watching",(r,e)=>{e?n==null||n.start():n==null||n.pause()});a.app.whenReady().then(()=>{p(),a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&p()})});a.app.on("window-all-closed",()=>{n==null||n.stop(),process.platform!=="darwin"&&a.app.quit()});
